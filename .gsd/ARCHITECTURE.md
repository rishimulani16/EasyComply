# Architecture

> Auto-generated by /map on 2026-02-24 | Based on PRD v2.0

## Overview

**EZ Compliance Tracker v2** is a role-based SaaS compliance management platform for Indian companies. Three user roles ‚Äî **Developer**, **Company Admin**, and **Auditor** ‚Äî each have their own panel. The system auto-identifies applicable legal compliance rules, tracks deadlines, stores versioned documents on **AWS S3** (private bucket, presigned URL access), verifies documents via Tesseract OCR, and shows a weighted Compliance Score and Risk Score. Auditors have a read-only view and can flag suspicious documents.

---

## System Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  React Frontend (Vite)                       ‚îÇ
‚îÇ  LoginPage ‚Üí DeveloperDashboard / CompanyDashboard /         ‚îÇ
‚îÇ              AuditorDashboard [PLANNED]                      ‚îÇ
‚îÇ  Modals: UploadModal, MarkDoneModal, RuleModal,              ‚îÇ
‚îÇ          FlagModal [PLANNED], DocHistoryPanel [PLANNED]      ‚îÇ
‚îÇ  Auth: JWT Bearer in localStorage via axiosInstance          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ HTTP (axios ‚Üí localhost:8000)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 FastAPI Backend (uvicorn)                     ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  /auth           ‚Üí auth.py        (login ‚Üí JWT)              ‚îÇ
‚îÇ  /company        ‚Üí company.py     (signup, rebuild-cal,      ‚îÇ
‚îÇ                                    invite-auditor [PLANNED], ‚îÇ
‚îÇ                                    resolve-flag [PLANNED])   ‚îÇ
‚îÇ  /compliance     ‚Üí compliance.py  (dashboard, upload ‚Üí S3+  ‚îÇ
‚îÇ                                    OCR, markdone,            ‚îÇ
‚îÇ                                    presigned download        ‚îÇ
‚îÇ                                    [PLANNED],                ‚îÇ
‚îÇ                                    version history [PLANNED])‚îÇ
‚îÇ  /audit          ‚Üí auditor.py     [PLANNED]                  ‚îÇ
‚îÇ                    (read-only dashboard, flag doc,           ‚îÇ
‚îÇ                     view flags)                              ‚îÇ
‚îÇ  /developer      ‚Üí developer.py   (rule CRUD,               ‚îÇ
‚îÇ                                    companies list,           ‚îÇ
‚îÇ                                    emergency S3 delete       ‚îÇ
‚îÇ                                    [PLANNED])                ‚îÇ
‚îÇ  deps.py         ‚Üí JWT guards (require_company,              ‚îÇ
‚îÇ                    require_developer, require_auditor         ‚îÇ
‚îÇ                    [PLANNED])                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ SQLAlchemy (psycopg2)    ‚îÇ boto3
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PostgreSQL          ‚îÇ  ‚îÇ  AWS S3 (ap-south-1, private)    ‚îÇ
‚îÇ   7 tables            ‚îÇ  ‚îÇ  Bucket: EasyComply               ‚îÇ
‚îÇ   compliance_rules    ‚îÇ  ‚îÇ  Key format:                      ‚îÇ
‚îÇ   companies           ‚îÇ  ‚îÇ  company_{id}/rule_{id}_{slug}/  ‚îÇ
‚îÇ   users               ‚îÇ  ‚îÇ  v{n}_{YYYY-MM-DD}.{ext}         ‚îÇ
‚îÇ   compliance_calendar ‚îÇ  ‚îÇ  Access: presigned URL (1hr TTL) ‚îÇ
‚îÇ   compliance_documents‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ   audit_flags         ‚îÇ
‚îÇ   audit_log           ‚îÇ              Tesseract OCR (local)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    (file downloaded from S3 to /tmp/,
                               OCR run, file deleted immediately)
```

---

## Database Tables (7 Total)

| Table | Status | Purpose |
|-------|--------|---------|
| `compliance_rules` | ‚úÖ Exists | Master rule definitions |
| `companies` | ‚úÖ Exists | Subscribed company profiles |
| `users` | ‚úÖ Exists | Auth users ‚Äî roles: developer/company/auditor |
| `compliance_calendar` | ‚úÖ Exists | Per-company rule tracking (status, due dates) |
| `compliance_documents` | üî¥ PLANNED | Versioned document records (s3_key, OCR result, version_number) |
| `audit_flags` | üî¥ PLANNED | Auditor flagging records per document |
| `audit_log` | ‚úÖ Exists | Developer rule CRUD audit trail |

### Key Schema Details

**compliance_documents (NEW)**
```sql
doc_id, company_id, rule_id, calendar_id,
version_number, is_current, file_name, s3_key,
file_type, file_size_kb, ocr_status, ocr_result,
ocr_verified, renewal_date, next_due_date,
is_deleted, deleted_reason, uploaded_by, uploaded_at
```
> `document_url` column in `compliance_calendar` becomes **deprecated** once documents table is live ‚Äî `s3_key` in `compliance_documents` replaces it.

**audit_flags (NEW)**
```sql
flag_id, company_id, doc_id, flagged_by, reason,
flagged_at, resolved, resolved_by, resolved_at
```

**compliance_rules ‚Äî New columns vs v1**
- `fixed_due_day` INT ‚Äî for rules with fixed government deadlines (e.g. GST ‚Üí day 20)
- `fixed_due_month` INT ‚Äî for annual fixed deadlines
- `doc_scope` ‚Üí renamed from `scope` to `doc_scope`

---

## Components

### Frontend ‚Äî Existing

| Component | Location | Purpose |
|-----------|----------|---------|
| `LoginPage.jsx` | `frontend/src/pages/` | Email/password login, 3-way role redirect |
| `CompanyDashboard.jsx` | `frontend/src/pages/` | Compliance table (grouped panels), score ring, sort dropdown, upload/mark-done |
| `DeveloperDashboard.jsx` | `frontend/src/pages/` | Rule CRUD, company list |
| `CompanySignup.jsx` | `frontend/src/pages/` | Multi-step onboarding (4 steps) |
| `UploadModal.jsx` | `frontend/src/components/` | File upload ‚Üí OCR result display |
| `MarkDoneModal.jsx` | `frontend/src/components/` | Non-doc rule completion (renewal/expiry dates) |
| `RuleModal.jsx` | `frontend/src/components/` | Developer rule create/edit form |
| `ProtectedRoute.jsx` | `frontend/src/components/` | JWT guard for routes |
| `axiosInstance.js` | `frontend/src/api/` | Axios + Bearer token interceptor |

### Frontend ‚Äî Planned (PRD v2)

| Component | Purpose |
|-----------|---------|
| `AuditorDashboard.jsx` | Read-only compliance view, flag button on each doc version |
| `FlagModal.jsx` | Auditor flag submission (reason text area) |
| `DocHistoryPanel.jsx` | Slide-out panel showing all doc versions for a rule, Download button per version |
| `AuditorManagementScreen.jsx` | Company Admin invites auditor by email, lists active auditors |

### Backend ‚Äî Existing

| File | Key Endpoints |
|------|--------------|
| `main.py` | App entry point, CORS config |
| `routers/auth.py` | `POST /auth/login` |
| `routers/company.py` | `POST /company/signup`, `GET /company/rebuild-calendar` |
| `routers/compliance.py` | `GET /company/dashboard`, `POST /compliance/upload/{id}`, `PATCH /compliance/markdone/{id}` |
| `routers/developer.py` | Full rule CRUD, company list |
| `routers/deps.py` | `require_company`, `require_developer` JWT guards |
| `db/database.py` | SQLAlchemy engine, `get_db()` |
| `models/models.py` | ORM models (5 tables) |
| `models/schemas.py` | Pydantic v2 schemas |

### Backend ‚Äî Planned (PRD v2)

| File | Key Endpoints |
|------|--------------|
| `routers/auditor.py` | `GET /audit/dashboard`, `POST /audit/flag/{doc_id}`, `GET /audit/flags` |
| `routers/deps.py` (update) | Add `require_auditor` guard |
| `routers/compliance.py` (update) | `POST /compliance/upload/{id}` ‚Üí S3 + versioning; `GET /compliance/document/{id}/download` (presigned URL); `GET /compliance/document/history/{rule_id}` |
| `routers/company.py` (update) | `POST /company/invite-auditor`; `PATCH /company/flag/{flag_id}/resolve` |
| `routers/developer.py` (update) | `DELETE /developer/document/{doc_id}` (emergency S3 delete) |
| `services/s3_service.py` | boto3 wrapper: upload_to_s3, generate_presigned_url, delete_from_s3, get_next_version |
| `models/models.py` (update) | Add `ComplianceDocument`, `AuditFlag` ORM models |
| `models/schemas.py` (update) | Add schemas for documents, flags, invite, presigned URL response |

---

## Data Flow

### Upload (v2 ‚Äî S3 + Versioning)
1. Company Admin clicks Upload ‚Üí `POST /compliance/upload/{calendar_id}` (multipart)
2. **File held in RAM** ‚Äî NOT saved locally
3. `services/s3_service.py`: calculate `version = last_version + 1`, build s3_key
   ```
   s3_key = company_{id}/rule_{id}_{slug}/v{n}_{YYYY-MM-DD}.{ext}
   ```
4. boto3 streams file to S3 private bucket
5. Mark old `compliance_documents.is_current = FALSE`
6. Download from S3 to `/tmp/` ‚Üí run Tesseract OCR ‚Üí delete `/tmp/` file
7. Insert new row in `compliance_documents` (s3_key, ocr_result, renewal_date, version_number)
8. Update `compliance_calendar` status (COMPLETED / OVERDUE-PASS / FAILED)
9. Return OCR result + next_due_date to frontend

### Download / View (Presigned URL)
1. User (Company Admin or Auditor) clicks **Download** on any doc version
2. `GET /compliance/document/{doc_id}/download`
3. Backend looks up `s3_key` from `compliance_documents`
4. `boto3.generate_presigned_url(s3_key, ExpiresIn=3600)` ‚Üí 1-hour temp URL
5. Frontend opens URL in new tab ‚Üí PDF loads directly from S3
6. URL expires after 1 hour ‚Äî cannot be shared permanently

### Auditor Flag Flow
1. Auditor on `AuditorDashboard` sees document version ‚Üí clicks **üö© Flag**
2. `FlagModal` opens ‚Üí auditor enters reason ‚Üí `POST /audit/flag/{doc_id}`
3. Row inserted in `audit_flags` (flagged_by, reason, flagged_at)
4. Flag visible on both Auditor and Company Admin dashboards
5. Company Admin clicks **Resolve** ‚Üí `PATCH /company/flag/{flag_id}/resolve`
6. `audit_flags.resolved = TRUE`, `resolved_by`, `resolved_at` stored

### Compliance & Risk Score
```
IMPACT_WEIGHTS = { Imprisonment: 40, High: 30, Medium: 20, Low: 10 }
STATUS_MULTIPLIERS = { COMPLETED: 1.0, OVERDUE-PASS: 0.5, PENDING: 0.0, FAILED: 0.0 }

Compliance Score = Œ£(weight √ó multiplier) / Œ£(weight) √ó 100
Risk Score       = Œ£(weight of OVERDUE rules only) / Œ£(weight) √ó 100
```

### Due Date Priority Logic
```python
# Priority 1: Fixed government deadline
if rule.fixed_due_day and rule.fixed_due_month:
    next_due = date(current_year, rule.fixed_due_month, rule.fixed_due_day)

# Priority 2: OCR-extracted renewal date from document
elif ocr_extracted_date:
    next_due = ocr_extracted_date + relativedelta(months=rule.frequency_months)

# Priority 3: Fallback ‚Äî company signup date + frequency
else:
    next_due = company.created_at + relativedelta(months=rule.frequency_months)
```

---

## Integration Points

| Service | Type | Purpose | Status |
|---------|------|---------|--------|
| PostgreSQL | Database | All persistent data | ‚úÖ Live |
| Supabase Auth | Auth/JWT | Token issuance; python-jose validates | ‚úÖ Live |
| Tesseract OCR | Local binary | Text extraction from uploaded docs | ‚úÖ Live |
| pdf2image / Poppler | Local lib | PDF ‚Üí image for OCR | ‚úÖ Live |
| AWS S3 (boto3) | Object Storage | Versioned private doc storage + presigned URLs | üî¥ Planned |
| SendGrid | Email | Due date reminders, auditor invites | ‚ùå Post-MVP |

---

## API Endpoints (Full v2 Map)

### Auth
| Method | Endpoint | Roles | Status |
|--------|----------|-------|--------|
| POST | `/auth/login` | All | ‚úÖ Exists |

### Company Admin
| Method | Endpoint | Roles | Status |
|--------|----------|-------|--------|
| POST | `/company/signup` | Public | ‚úÖ Exists |
| GET | `/company/dashboard` | Company | ‚úÖ Exists |
| GET | `/company/rebuild-calendar` | Company | ‚úÖ Exists |
| POST | `/company/invite-auditor` | Company | üî¥ Planned |
| PATCH | `/company/flag/{flag_id}/resolve` | Company | üî¥ Planned |

### Compliance & Documents
| Method | Endpoint | Roles | Status |
|--------|----------|-------|--------|
| POST | `/compliance/upload/{calendar_id}` | Company | ‚úÖ Exists (local) ‚Üí üî¥ S3 migration |
| PATCH | `/compliance/markdone/{calendar_id}` | Company | ‚úÖ Exists |
| GET | `/compliance/document/{doc_id}/download` | Company+Auditor | üî¥ Planned |
| GET | `/compliance/document/history/{rule_id}` | Company+Auditor | üî¥ Planned |

### Auditor
| Method | Endpoint | Roles | Status |
|--------|----------|-------|--------|
| GET | `/audit/dashboard` | Auditor | üî¥ Planned |
| POST | `/audit/flag/{doc_id}` | Auditor | üî¥ Planned |
| GET | `/audit/flags` | Company+Auditor | üî¥ Planned |

### Developer
| Method | Endpoint | Roles | Status |
|--------|----------|-------|--------|
| GET | `/developer/companies` | Developer | ‚úÖ Exists |
| GET | `/developer/rules` | Developer | ‚úÖ Exists |
| POST | `/developer/rules` | Developer | ‚úÖ Exists |
| PUT | `/developer/rules/{id}` | Developer | ‚úÖ Exists |
| DELETE | `/developer/rules/{id}` | Developer | ‚úÖ Exists |
| DELETE | `/developer/document/{doc_id}` | Developer | üî¥ Planned |

---

## Conventions

- **Naming:** `camelCase` JS/JSX, `snake_case` Python. PascalCase for React components.
- **Auth:** JWT Bearer in `localStorage`; Axios interceptor attaches it. Role embedded in JWT payload.
- **Dates:** Backend sends plain ISO strings; frontend appends `T00:00:00` before `new Date()` to avoid UTC-midnight IST offset.
- **Status values:** `PENDING | COMPLETED | OVERDUE-PASS | FAILED` (OVERDUE removed from app logic, PRD v2 mentions it for risk score calculation only).
- **Soft deletes:** Rules use `is_active = FALSE`. Documents use `is_deleted = TRUE` (Developer only for S3 hard-delete).
- **S3 keys:** Never store full S3 URLs ‚Äî only `s3_key`. Generate presigned URLs on demand.
- **Testing:** No automated tests currently exist.

---

## Technical Debt

- [ ] **[BLOCKING for v2]** No `compliance_documents` or `audit_flags` tables ‚Äî must be created before S3/auditor work
- [ ] **[BLOCKING for v2]** `routers/compliance.py` saves files locally ‚Äî must be migrated to S3 with boto3
- [ ] **[BLOCKING for v2]** No `auditor` role guard (`require_auditor`) in `deps.py`
- [ ] **[BLOCKING for v2]** `users` table `role` CHECK constraint only includes `developer | company` ‚Äî needs `auditor` added
- [ ] `scope` column in existing model/code called `scope`; PRD v2 renames it to `doc_scope` ‚Äî migration needed
- [ ] `declarative_base()` from `sqlalchemy.ext.declarative` deprecated in SQLAlchemy 2.x ‚Äî use `sqlalchemy.orm.DeclarativeBase`
- [ ] No automated test suite (unit or integration)
- [ ] CORS `allow_origins` is fully open ‚Äî tighten before production
- [ ] `demo_seed.py` has hardcoded credentials ‚Äî never commit to production
- [ ] No pagination on `/developer/companies` or `/developer/rules`
- [ ] Duplicate docstring block in `compliance.py` lines 182‚Äì189
- [ ] No input sanitisation on `ocr_result` before DB storage
