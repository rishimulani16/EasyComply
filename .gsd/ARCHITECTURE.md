# Architecture

> Auto-generated by /map on 2026-02-24

## Overview

**EZ Compliance Tracker** is a role-based SaaS compliance management platform for Indian companies. It auto-identifies applicable legal compliance rules (GST, PF, ESI, state-specific acts) based on a company's profile, tracks deadlines, and verifies uploaded documents using Tesseract OCR.

Two user roles exist: **Developer/Owner** (manages rules & views all companies) and **Company Admin** (manages their own compliance dashboard & uploads).

## System Diagram

```
┌──────────────────────────────────────────────────────┐
│              React Frontend (Vite)                   │
│   LoginPage → CompanyDashboard / DeveloperDashboard  │
│   Modals: UploadModal, MarkDoneModal, RuleModal       │
│   Auth: JWT stored in localStorage via axiosInstance  │
└────────────────────┬─────────────────────────────────┘
                     │ HTTP (axios, localhost:8000)
┌────────────────────▼─────────────────────────────────┐
│              FastAPI Backend (uvicorn)                │
│   /auth  → auth.py        (login, register)          │
│   /company → company.py   (signup, rebuild-calendar) │
│   /compliance → compliance.py (dashboard, upload,    │
│                                markdone)             │
│   /developer → developer.py (rule CRUD, companies)   │
│   deps.py → JWT dependency guards (require_company / │
│              require_developer)                      │
└────────────────────┬─────────────────────────────────┘
                     │ SQLAlchemy ORM (psycopg2)
┌────────────────────▼─────────────────────────────────┐
│         PostgreSQL Database                          │
│   compliance_rules  | companies | users              │
│   compliance_calendar | audit_log                    │
└──────────────────────────────────────────────────────┘
                     │
              Tesseract OCR (local)
```

---

## Components

### Frontend

#### `LoginPage.jsx`
- **Purpose:** Email/password login, role-based redirect (developer → DeveloperDashboard, company → CompanyDashboard)
- **Location:** `frontend/src/pages/LoginPage.jsx`
- **Dependencies:** axiosInstance, react-router-dom, jwt-decode

#### `CompanyDashboard.jsx`
- **Purpose:** Main compliance view for Company Admins. Stat cards, compliance score ring, grouped panels (per-state + company-wide), sort dropdown (Renewal Date / Penalty Impact), upload/mark-done actions.
- **Location:** `frontend/src/pages/CompanyDashboard.jsx`
- **Dependencies:** UploadModal, MarkDoneModal, axiosInstance

#### `DeveloperDashboard.jsx`
- **Purpose:** Developer panel — list of all subscribed companies, compliance rule CRUD (add/edit/soft-delete)
- **Location:** `frontend/src/pages/DeveloperDashboard.jsx`
- **Dependencies:** RuleModal, axiosInstance

#### `CompanySignup.jsx`
- **Purpose:** Multi-step onboarding form — account setup → company profile → branch locations (Enterprise)
- **Location:** `frontend/src/pages/CompanySignup.jsx`
- **Dependencies:** axiosInstance, react-hook-form, react-router-dom

#### `UploadModal.jsx`
- **Purpose:** Document upload modal — PDFs/images sent to `/compliance/upload/{id}`, OCR result displayed
- **Location:** `frontend/src/components/UploadModal.jsx`

#### `MarkDoneModal.jsx`
- **Purpose:** Non-document rule completion modal — accepts renewal date, optional expiry date, note
- **Location:** `frontend/src/components/MarkDoneModal.jsx`

#### `RuleModal.jsx`
- **Purpose:** Developer rule create/edit form (all compliance_rules fields)
- **Location:** `frontend/src/components/RuleModal.jsx`

#### `axiosInstance.js`
- **Purpose:** Axios instance with base URL + JWT Bearer token interceptor (reads from localStorage)
- **Location:** `frontend/src/api/axiosInstance.js`

#### `ProtectedRoute.jsx`
- **Purpose:** Route guard — checks JWT presence; redirects to `/` if missing
- **Location:** `frontend/src/components/ProtectedRoute.jsx`

---

### Backend

#### `main.py`
- **Purpose:** FastAPI app entry point — registers 4 routers, configures CORS for `localhost:3000` + `5173`
- **Location:** `backend/main.py`

#### `routers/auth.py`
- **Purpose:** `POST /auth/login` — validates email/password, returns JWT with role + company_id
- **Location:** `backend/routers/auth.py`
- **Dependencies:** deps.py, models, passlib, python-jose

#### `routers/company.py`
- **Purpose:** `POST /company/signup` (auto-match rules → populate compliance_calendar), `GET /company/rebuild-calendar`
- **Location:** `backend/routers/company.py`
- **Dependencies:** db, models, schemas

#### `routers/compliance.py`
- **Purpose:** `GET /company/dashboard` (enriched calendar + compliance score), `POST /compliance/upload/{id}` (OCR pipeline), `PATCH /compliance/markdone/{id}`
- **Location:** `backend/routers/compliance.py`
- **Dependencies:** pytesseract, Pillow, pdf2image, dateutil, db, models

#### `routers/developer.py`
- **Purpose:** Developer CRUD: `GET/POST /developer/rules`, `PUT/DELETE /developer/rules/{id}`, `GET /developer/companies`, audit log writes
- **Location:** `backend/routers/developer.py`
- **Dependencies:** db, models, schemas

#### `routers/deps.py`
- **Purpose:** FastAPI JWT dependency functions (`require_company`, `require_developer`) — decodes Bearer token, validates role
- **Location:** `backend/routers/deps.py`
- **Dependencies:** python-jose

#### `db/database.py`
- **Purpose:** SQLAlchemy engine (psycopg2), `SessionLocal`, `Base`, `get_db()` FastAPI dependency
- **Location:** `backend/db/database.py`

#### `models/models.py`
- **Purpose:** SQLAlchemy ORM models for all 5 tables (`ComplianceRule`, `Company`, `User`, `ComplianceCalendar`, `AuditLog`)
- **Location:** `backend/models/models.py`

#### `models/schemas.py`
- **Purpose:** Pydantic v2 request/response schemas for all models
- **Location:** `backend/models/schemas.py`

---

## Data Flow

### Company Signup
1. `POST /company/signup` receives profile + credentials
2. Auto-matching SQL query filters `compliance_rules` by `industry_type`, `applicable_states`, `company_type`, `employee_count`
3. One `compliance_calendar` row per matched rule (×1 for Basic, ×branch_states for Enterprise/Branch-scope rules) is inserted with `status = PENDING`
4. JWT returned — Company Admin auto-logged in

### Document Upload & OCR
1. Company Admin clicks Upload → `UploadModal` sends `POST /compliance/upload/{calendar_id}` (multipart)
2. File saved to `backend/uploads/`
3. Tesseract OCR extracts text (pdf2image for PDFs)
4. Earliest date in document = **issue date**; `effective_expiry = issue_date + frequency_months`
5. `effective_expiry > today` → `COMPLETED` or `OVERDUE-PASS`; else → `FAILED`
6. `compliance_calendar` row updated; `due_date` rolled forward on pass

### Mark Done (no document)
1. `PATCH /compliance/markdone/{calendar_id}` with optional `renewal_date`, `expiry_date`, `note`
2. `next_due_date = anchor + frequency_months` (anchor = expiry_date > renewal_date > today)
3. Status set to `COMPLETED`

### Dashboard Load
1. `GET /company/dashboard` joins `compliance_calendar` + `compliance_rules`
2. Weighted compliance score computed server-side (`Imprisonment:40, High:30, Medium:20, Low:10`)
3. Frontend groups rows: Branch-scope or single-state Company-scope → per-state panels; rest → Company-wide panel
4. User can sort rows per panel by **Renewal Date** (nearest first) or **Penalty Impact** (severity order)

---

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| PostgreSQL | Database | All persistent data (rules, companies, calendar, audit) |
| Supabase Auth | Auth (JWT) | Token issuance and validation (python-jose consumer side) |
| Tesseract OCR | Local binary | Text extraction from uploaded compliance documents |
| pdf2image / Poppler | Local lib | PDF → image conversion before OCR |
| React (Vite) | Frontend framework | SPA client |
| FastAPI | Backend framework | REST API, dependency injection, OpenAPI docs |

---

## Conventions

- **Naming:** `camelCase` for JS/JSX, `snake_case` for Python. Components are PascalCase JSX files.
- **Structure:** Feature split by role (company vs developer). Backend is flat-router style, no service layer.
- **Auth:** JWT Bearer token stored in `localStorage`; attached via Axios request interceptor.
- **Dates:** Backend sends plain ISO date strings (no timezone); frontend appends `T00:00:00` before parsing to avoid UTC-midnight IST offset.
- **Status values:** `PENDING | COMPLETED | OVERDUE-PASS | FAILED` (OVERDUE removed in recent cleanup).
- **Soft deletes:** Rules use `is_active = FALSE` (no hard delete).
- **Testing:** No automated tests currently exist.

---

## Technical Debt

- [ ] No automated test suite (unit or integration tests)
- [ ] CORS `allow_origins` is open (`*` methods/headers) — tighten before production
- [ ] Files stored locally in `backend/uploads/` — should migrate to S3/Cloudinary
- [ ] No email alerts for approaching deadlines (SendGrid/SMTP planned post-MVP)
- [ ] `OVERDUE` status still referenced in `schema.sql` CHECK constraint but removed from app logic — DB constraint needs cleanup
- [ ] Duplicate router docstring block in `compliance.py` (lines 182–189 repeat the upload endpoint comment)
- [ ] No input sanitisation on OCR text before storage in `ocr_result`
- [ ] `demo_seed.py` contains hardcoded credentials — should never be committed to production
- [ ] No pagination on `/developer/companies` or `/developer/rules` — will degrade at scale
- [ ] `declarative_base()` from `sqlalchemy.ext.declarative` is deprecated in SQLAlchemy 2.x — should use `sqlalchemy.orm.DeclarativeBase`
